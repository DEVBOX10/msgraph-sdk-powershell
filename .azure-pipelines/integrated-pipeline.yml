# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

name: 'Integrated Pipeline'
variables:
- name: AUTH_MODULE_NAME
  value: 'Authentication'
- name: AUTH_MODULE_PATH
  value: 'src\Authentication\Authentication'
- name: AUTH_MODULE_DLL_PATTERN
  value: 'Microsoft.Graph.Authentication.dll'
- name: MODULE_DLL_PATTERN
  value: 'Microsoft.Graph.Authentication.dll'
- name: MODULE_PREFIX
  value: 'Microsoft.Graph'
- name: ROLLUP_MODULE_NAME
  value: 'Graph'
- name: ROLLUP_MODULE_PATH
  value: 'src/Graph/Graph'
- name: WORKLOAD_MODULE_PATH
  value: 'src'
- name: GRAPH_VERSION
  value: 'beta'
- name: Api_Key
  value: 'Api_Key'
- name: EnableSigning
  value: true
- name: BRANCH_PREFIX
  value: 'releaseOpenApiDocs'
- name: GitUserEmail
  value: 'GraphTooling@service.microsoft.com'
- name: GitUserName
  value: 'Microsoft Graph DevX Tooling'
  
pool: MsGraphDevXAzureAgents
trigger:
    branches:
      include:
      - master
      - dev
      - releases/*
      - bugfixes/*

stages:


- stage: DownloadOpenApiDocs
  displayName: 'Download Open Api Docs from DevX API'
  jobs:
  - job: DownloadOpenAPiDocs
    steps:
    - template: ./download-openapidocs-template.yml
      parameters: 
        BaseBranch: $(System.PullRequest.TargetBranch)
        BRANCH_PREFIX: $(BRANCH_PREFIX)
        GitUserEmail: $(GitUserEmail)
        GitUserName: $(GitUserName)
        

- stage: GenerateProfiles
  displayName: 'Generate Profiles'
  jobs:
  - job: GenerateProfiles
    steps:
    - template: ./generate-profiles-template.yml

- stage: GenerateAuthModule
  displayName: 'Generate Authentication Module (Microsoft.Graph.Authentication)'
  jobs:
  - template: ./generate-auth-module-template.yml
    parameters:
      Api_Key: $(Api_Key)
      AUTH_MODULE_NAME: $(AUTH_MODULE)
      AUTH_MODULE_PATH: $(AUTH_MODULE_PATH)
      AUTH_MODULE_DLL_PATTERN: $(AUTH_MODULE_DLL_PATTERN)
      EnableSigning: true

    
- stage: GenerateBetaModules
  displayName: 'Generate Beta Modules (Microsoft.Graph.*)'
  jobs:
  - template: ./generate-modules-template.yml
    parameters:
      Api_Key: $(Api_Key)
      MODULE_PREFIX: $(MODULE_PREFIX)
      WORKLOAD_MODULE_PATH: $(WORKLOAD_MODULE_PATH)
      GRAPH_VERSION: $(GRAPH_VERSION)
      AUTH_MODULE_PATH: $(AUTH_MODULE_PATH)
      AUTH_MODULE_DLL_PATTERN: $(AUTH_MODULE_DLL_PATTERN)
      EnableSigning: true

- stage: GenerateRollUpModule
  displayName: 'Generate Roll-Up Module'
  jobs:
  - template: ./generate-rollup-module-template.yml
    parameters:
      Api_Key: $(Api_Key)
      ROLLUP_MODULE_PATH: $(ROLLUP_MODULE_PATH)
      ROLLUP_MODULE_NAME: $(ROLLUP_MODULE_NAME)
      GRAPH_VERSION: $(GRAPH_VERSION)
      MODULE_PREFIX: $(MODULE_PREFIX)
      EnableSigning: true